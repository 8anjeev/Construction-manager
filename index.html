<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Sanjineer - Construction Manager App</title>
  <meta name="description" content="Construction site management app by Sanjineer">
  <meta name="theme-color" content="#4f46e5">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ConstructMgr">
  <link rel="manifest" id="pwa-manifest">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #4f46e5; --primary-dark: #3730a3; --accent: #f59e0b; --bg-dark: #0f172a; }
    * { font-family: 'Outfit', sans-serif; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); min-height: 100vh; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
    ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.4); border-radius: 3px; }
    @keyframes fadeSlideIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    @keyframes slideUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.5;} }
    .tab-content { animation: fadeSlideIn 0.18s ease-out; }
    .stat-card { transition: transform 0.12s ease; }
    .stat-card:hover { transform: translateY(-2px); }
    .glass { background: rgba(255,255,255,0.96); backdrop-filter: blur(10px); }
    .glass-dark { background: rgba(255,255,255,0.07); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.1); }
    .tab-btn { position:relative; transition: all 0.15s ease; }
    .tab-btn.active { background: linear-gradient(135deg, rgba(255,255,255,0.22), rgba(255,255,255,0.12)); box-shadow: 0 3px 14px rgba(0,0,0,0.25); }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
    input[type="number"] { -moz-appearance: textfield; }
    .expand-content { max-height:0; overflow:hidden; transition: max-height 0.25s ease-out; }
    .expand-content.expanded { max-height:700px; }
    .calendar-day { transition: transform 0.1s ease, background-color 0.1s ease; min-height: 3.5rem; cursor:pointer; }
    .calendar-day:hover { transform: scale(1.05); }
    .delete-confirm { animation: slideUp 0.15s ease-out; }
    .spinner { animation: spin 0.8s linear infinite; }
    #pwa-banner { position: fixed; bottom: 0; left: 0; right: 0; z-index: 200; background: linear-gradient(135deg, #4f46e5, #7c3aed); padding: 0.75rem 1rem; display: none; align-items: center; justify-content: space-between; box-shadow: 0 -4px 20px rgba(79,70,229,0.4); }
    #apk-modal { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; padding: 1rem; }
    #apk-modal.show { display: flex; }
    .apk-card { background: linear-gradient(135deg, #1e1b4b, #312e81); border: 1px solid rgba(255,255,255,0.15); border-radius: 1.5rem; padding: 1.75rem; width: 100%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .apk-step { background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12); border-radius: 0.875rem; padding: 0.875rem 1rem; margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 0.75rem; }
    .apk-step-num { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #ea580c); display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 0.8rem; flex-shrink: 0; }
    .apk-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 0.875rem; border: none; border-radius: 0.875rem; font-weight: 700; font-size: 0.95rem; cursor: pointer; font-family: 'Outfit', sans-serif; transition: opacity 0.15s, transform 0.1s; }
    .apk-btn:hover { opacity: 0.9; }
    .apk-btn:active { transform: scale(0.98); }
    #workers-list, #contractors-list, #materials-table, #tools-table, #rentals-table, #rentals-given-table, #daily-labour-table { contain: content; }
    main, .overflow-x-auto { -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>
<div id="app" class="h-full w-full flex flex-col">
  <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 p-3 shadow-2xl no-print">
    <div class="flex items-center justify-between">
      <div class="flex items-start gap-3">
        <div class="relative w-11 h-11 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-xl flex-shrink-0">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="8" y="10" width="8" height="3" rx="0.5" fill="currentColor" stroke="none"/><circle cx="12" cy="11.5" r="2.5" fill="none" stroke="currentColor" stroke-width="1.2"/><circle cx="12" cy="11.5" r="1.2" fill="#86efac" stroke="none"/><line x1="12" y1="13" x2="7" y2="20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><line x1="12" y1="13" x2="17" y2="20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><line x1="12" y1="13" x2="12" y2="20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><circle cx="7" cy="20" r="0.8" fill="currentColor"/><circle cx="12" cy="20" r="0.8" fill="currentColor"/><circle cx="17" cy="20" r="0.8" fill="currentColor"/></svg>
        </div>
        <div>
          <div class="flex items-center gap-2"><h1 class="text-xl font-black text-white tracking-tight">Sanjineer</h1><p id="header-date-inline" class="text-purple-200 text-[10px] font-medium hidden sm:block"></p></div>
          <p class="text-amber-300 text-xs font-bold">Er Sanjeev</p>
          <p class="text-purple-100 text-[10px] font-medium">Elite Builder, Designer &amp; Contractor</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div class="text-right"><p class="text-purple-200 text-[10px]">Total Spends</p><p id="header-spends" class="text-rose-300 font-bold text-xl">â‚¹0</p></div>
        <button onclick="showApkModal()" title="Download as APK" class="w-9 h-9 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg hover:opacity-90 transition-all active:scale-95 flex-shrink-0"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3"/></svg></button>
      </div>
    </div>
  </header>
  <nav class="bg-white/10 backdrop-blur-sm border-b border-white/10 sticky top-0 z-30 px-2 no-print">
    <div class="flex overflow-x-auto gap-1 py-1.5" style="scrollbar-width:none;">
      <button class="tab-btn flex-shrink-0 px-4 py-1.5 text-xs font-semibold text-white/70 hover:text-white rounded-lg" data-tab="dashboard">ğŸ“Š Dashboard</button>
      <button class="tab-btn flex-shrink-0 px-4 py-1.5 text-xs font-semibold text-white/70 hover:text-white rounded-lg" data-tab="daily">ğŸ“‹ Daily Report</button>
      <button class="tab-btn flex-shrink-0 px-4 py-1.5 text-xs font-semibold text-white/70 hover:text-white rounded-lg" data-tab="attendance">ğŸ“… Attendance</button>
      <button class="tab-btn flex-shrink-0 px-4 py-1.5 text-xs font-semibold text-white/70 hover:text-white rounded-lg" data-tab="material">ğŸ§± Material</button>
      <button class="tab-btn flex-shrink-0 px-4 py-1.5 text-xs font-semibold text-white/70 hover:text-white rounded-lg" data-tab="tools">ğŸ”§ Tools</button>
      <button class="tab-btn flex-shrink-0 px-4 py-1.5 text-xs font-semibold text-white/70 hover:text-white rounded-lg" data-tab="rentals">ğŸ“¦ Rentals</button>
      <button class="tab-btn flex-shrink-0 px-4 py-1.5 text-xs font-semibold text-white/70 hover:text-white rounded-lg" data-tab="contractors">ğŸ‘¥ Teams</button>
    </div>
  </nav>  <main class="flex-1 overflow-y-auto p-3">
    <div id="tab-dashboard" class="tab-content" style="display:none;">
      <div class="grid grid-cols-2 gap-2.5 mb-3">
        <div class="stat-card bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl p-3 text-white shadow-xl"><p class="text-amber-100 text-[10px] font-medium">Advances Given</p><p id="dash-advance" class="text-xl font-bold mt-0.5">â‚¹0</p><p class="text-amber-200 text-[10px] mt-0.5">This Month</p></div>
        <div class="stat-card bg-gradient-to-br from-rose-500 to-pink-500 rounded-xl p-3 text-white shadow-xl"><p class="text-rose-100 text-[10px] font-medium">Remaining Payments</p><p id="dash-remaining" class="text-xl font-bold mt-0.5">â‚¹0</p><p class="text-rose-200 text-[10px] mt-0.5">After Advances</p></div>
      </div>
      <div class="grid grid-cols-3 gap-2.5 mb-3">
        <div class="stat-card bg-gradient-to-br from-emerald-500 to-teal-500 rounded-xl p-3 text-white shadow-xl"><p class="text-emerald-100 text-[10px] font-medium">Material Purchase</p><p id="dash-material" class="text-xl font-bold mt-0.5">â‚¹0</p><p class="text-emerald-200 text-[10px] mt-0.5">This Month</p></div>
        <div class="stat-card bg-gradient-to-br from-cyan-500 to-sky-500 rounded-xl p-3 text-white shadow-xl"><p class="text-cyan-100 text-[10px] font-medium">Petty Cash In</p><p id="dash-petty" class="text-xl font-bold mt-0.5">â‚¹0</p><p class="text-cyan-200 text-[10px] mt-0.5">Total Deposited</p></div>
        <div class="stat-card bg-gradient-to-br from-violet-500 to-purple-500 rounded-xl p-3 text-white shadow-xl"><p class="text-violet-100 text-[10px] font-medium">Petty Cash Left</p><p id="dash-petty-remaining" class="text-xl font-bold mt-0.5">â‚¹0</p><p class="text-violet-200 text-[10px] mt-0.5">Available</p></div>
      </div>
      <div class="grid grid-cols-2 gap-2.5 mb-3">
        <div class="stat-card bg-gradient-to-br from-indigo-500 to-violet-500 rounded-xl p-3 text-white shadow-xl"><p class="text-indigo-100 text-[10px] font-medium">Rental Expenses</p><p id="dash-rental-out" class="text-xl font-bold mt-0.5">â‚¹0</p><p class="text-indigo-200 text-[10px] mt-0.5">Equipment Rented</p></div>
        <div class="stat-card bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl p-3 text-white shadow-xl"><p class="text-green-100 text-[10px] font-medium">Rental Income</p><p id="dash-rental-in" class="text-xl font-bold mt-0.5">â‚¹0</p><p class="text-green-200 text-[10px] mt-0.5">Given to Others</p></div>
      </div>
      <div class="glass rounded-xl p-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-2.5">Teams Overview (This Month)</h3><div id="team-details" class="space-y-2.5"><p class="text-gray-400 text-center py-3 text-sm">No teams added yet</p></div></div>
    </div>
    <div id="tab-daily" class="tab-content" style="display:none;">
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><div class="flex items-center justify-between flex-wrap gap-2"><h3 class="text-lg font-bold text-gray-800">ğŸ“… Daily Report</h3><div class="flex items-center gap-2 flex-wrap"><input type="date" id="daily-report-date" class="view-ok px-3 py-2 border border-gray-200 rounded-xl text-sm font-medium focus:outline-none focus:border-indigo-400"><button onclick="loadDailyReport()" class="view-ok flex items-center gap-1.5 px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all active:scale-95">ğŸ“‚ Load</button><button onclick="printDailyReport()" class="view-ok flex items-center gap-1.5 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all active:scale-95">ğŸ–¨ï¸ Print</button></div></div><p id="daily-report-label" class="text-xs text-gray-500 mt-2 font-medium"></p></div>
      <div class="grid grid-cols-2 gap-3 mb-3"><div class="bg-gradient-to-br from-rose-500 to-pink-500 rounded-xl p-3 text-white"><p class="text-xs text-rose-100">Advances Today</p><p id="daily-payments" class="text-xl font-bold">â‚¹0</p></div><div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl p-3 text-white"><p class="text-xs text-amber-100">Material Expenses</p><p id="daily-material" class="text-xl font-bold">â‚¹0</p></div></div>
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ§± Materials Purchased</h3><div class="overflow-x-auto"><table class="w-full text-sm print-table"><thead><tr class="bg-gradient-to-r from-amber-500 to-orange-500 text-white"><th class="px-3 py-2 text-left rounded-l-lg">Material Name</th><th class="px-3 py-2 text-center">Quantity</th><th class="px-3 py-2 text-right rounded-r-lg">Amount</th></tr></thead><tbody id="daily-materials-table"><tr><td colspan="3" class="px-3 py-4 text-center text-gray-400">No materials purchased</td></tr></tbody></table></div></div>
      <div class="glass rounded-2xl p-4 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ‘· Labour Summary</h3><div class="overflow-x-auto"><table class="w-full text-sm print-table"><thead><tr class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white"><th class="px-3 py-2 text-left rounded-l-lg">Worker Type</th><th class="px-3 py-2 text-center">Count</th><th class="px-3 py-2 text-center">Total Hrs</th><th class="px-3 py-2 text-left">Work Done</th><th class="px-3 py-2 text-center rounded-r-lg no-print">Action</th></tr></thead><tbody id="daily-labour-table"><tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">No attendance recorded today</td></tr></tbody></table></div></div>
    </div>
    <div id="tab-attendance" class="tab-content" style="display:none;">
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><div class="flex items-center justify-between flex-wrap gap-2"><div><h3 class="text-base font-bold text-gray-800">ğŸ–¨ï¸ Print Monthly Report</h3><p class="text-xs text-gray-500 mt-0.5">Attendance + Payments grouped by Team</p></div><div class="flex items-center gap-2 flex-wrap"><select id="print-month-select" class="view-ok px-3 py-2 border border-gray-200 rounded-xl text-sm bg-white focus:outline-none focus:border-indigo-400"></select><button onclick="printMonthlyReport()" class="view-ok flex items-center gap-1.5 px-4 py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all active:scale-95">ğŸ–¨ï¸ Print PDF</button></div></div></div>
      <select id="export-month-select" class="hidden"></select>
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">â• Add New Worker</h3><div class="grid grid-cols-2 md:grid-cols-5 gap-3"><input type="text" id="worker-name" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Worker Name"><select id="worker-category" class="px-3 py-2 border border-gray-200 rounded-xl bg-white text-sm focus:outline-none focus:border-indigo-400"><option value="">Select Role</option><option>Mason</option><option>Labour</option><option>Carpenter</option><option>Helper</option><option>Fitter</option><option>Fitter Helper</option><option>Supervisor</option></select><select id="worker-team-select" class="px-3 py-2 border border-gray-200 rounded-xl bg-white text-sm focus:outline-none focus:border-indigo-400"><option value="">Select Team</option></select><input type="number" id="worker-wage" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Hourly Wage (â‚¹)" step="any"><button onclick="addWorker()" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Add Worker</button></div></div>
      <div class="glass rounded-2xl p-4 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ‘· Workers List</h3><div id="workers-list"><p class="text-gray-400 text-center py-4">No workers added yet</p></div></div>
    </div>
    <div id="tab-material" class="tab-content" style="display:none;">
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ’° Deposit Petty Cash</h3><div class="grid grid-cols-3 gap-3"><input type="number" id="petty-cash-amount" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Amount (â‚¹)" step="any"><input type="date" id="petty-cash-date" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"><button onclick="addPettyCash()" class="bg-gradient-to-r from-cyan-500 to-sky-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Deposit Cash</button></div></div>
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">â• Add Material Purchase</h3><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" id="material-name" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Material Name"><input type="number" id="material-quantity" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Quantity" step="any"><input type="number" id="material-cost" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Total Cost (â‚¹)" step="any"><input type="date" id="material-date" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"></div><button onclick="addMaterial()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Add Material</button></div>
      <div class="grid grid-cols-3 gap-3 mb-3"><div class="bg-gradient-to-br from-emerald-500 to-teal-500 rounded-xl p-4 text-white"><p class="text-xs text-emerald-100">Total Material Cost</p><p id="total-material-cost" class="text-2xl font-bold">â‚¹0</p></div><div class="bg-gradient-to-br from-cyan-500 to-sky-500 rounded-xl p-4 text-white"><p class="text-xs text-cyan-100">Petty Cash Deposited</p><p id="total-petty-cash" class="text-2xl font-bold">â‚¹0</p></div><div class="bg-gradient-to-br from-violet-500 to-purple-500 rounded-xl p-4 text-white"><p class="text-xs text-violet-100">Remaining Petty Cash</p><p id="remaining-petty-cash" class="text-2xl font-bold">â‚¹0</p></div></div>
      <div class="glass rounded-2xl p-4 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ“¦ Materials & Petty Cash</h3><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white"><th class="px-3 py-2 text-left rounded-l-lg">Date</th><th class="px-3 py-2 text-left">Name</th><th class="px-3 py-2 text-center">Qty</th><th class="px-3 py-2 text-right">Cost</th><th class="px-3 py-2 text-center rounded-r-lg">Action</th></tr></thead><tbody id="materials-table"><tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">No materials added yet</td></tr></tbody></table></div></div>
    </div>    <div id="tab-tools" class="tab-content" style="display:none;">
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">â• Add Tool / Equipment</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-3"><input type="text" id="tool-name" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Tool Name"><input type="number" id="tool-quantity" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Quantity" step="any"><input type="date" id="tool-date" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"><input type="number" id="tool-cost" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Cost (Optional)" step="any"></div><button onclick="addTool()" class="w-full mt-3 bg-gradient-to-r from-violet-500 to-purple-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Add Tool</button></div>
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">   Tools & Equipment</h3><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gradient-to-r from-violet-500 to-purple-500 text-white"><th class="px-3 py-2 text-left rounded-l-lg">Tool</th><th class="px-3 py-2 text-center">Qty</th><th class="px-3 py-2 text-center">Date</th><th class="px-3 py-2 text-right">Cost</th><th class="px-3 py-2 text-center rounded-r-lg">Action</th></tr></thead><tbody id="tools-table"><tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">No tools added yet</td></tr></tbody></table></div></div>
      <div class="glass rounded-2xl p-4 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ“‹ Tool Assignments</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3"><select id="assign-tool" class="px-3 py-2 border border-gray-200 rounded-xl bg-white text-sm focus:outline-none focus:border-indigo-400"><option value="">Select Tool</option></select><select id="assign-worker" class="px-3 py-2 border border-gray-200 rounded-xl bg-white text-sm focus:outline-none focus:border-indigo-400"><option value="">Select Worker</option></select><input type="date" id="assign-date" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"><button onclick="assignTool()" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Assign</button></div><div id="tool-assignments"><p class="text-gray-400 text-center py-4">No tool assignments</p></div></div>
    </div>
    <div id="tab-rentals" class="tab-content" style="display:none;">
      <div class="glass rounded-2xl p-3 mb-3 shadow-xl"><div class="flex gap-2"><button id="rental-tab-borrowed" class="rental-tab-btn flex-1 px-4 py-2 text-sm font-semibold rounded-xl transition-all bg-gradient-to-r from-rose-500 to-pink-500 text-white">ğŸ“¦ Equipment We Rented</button><button id="rental-tab-given" class="rental-tab-btn flex-1 px-4 py-2 text-sm font-semibold rounded-xl transition-all bg-white/20 text-gray-800">ğŸ’° Equipment Given to Others</button></div></div>
      <div id="rental-section-borrowed"><div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ“¦ Equipment We Rented</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3"><input type="text" id="rental-name" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Item Name"><input type="number" id="rental-quantity" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Quantity" step="any"><input type="number" id="rental-rate" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Daily Rate (â‚¹)" step="any"><input type="date" id="rental-date" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"></div><button onclick="addRental()" class="w-full bg-gradient-to-r from-rose-500 to-pink-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Add Rental</button><div class="mt-4 overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gradient-to-r from-rose-500 to-pink-500 text-white"><th class="px-3 py-2 text-left rounded-l-lg">Item</th><th class="px-3 py-2 text-center">Qty</th><th class="px-3 py-2 text-center">From</th><th class="px-3 py-2 text-center">Days</th><th class="px-3 py-2 text-right">Total</th><th class="px-3 py-2 text-center rounded-r-lg">Action</th></tr></thead><tbody id="rentals-borrowed-table"><tr><td colspan="6" class="px-3 py-4 text-center text-gray-400">No rentals yet</td></tr></tbody><tfoot><tr class="bg-rose-50"><td colspan="4" class="px-3 py-2 font-bold text-rose-700">Total Rental Expense</td><td id="total-rental-expense" class="px-3 py-2 text-right font-bold text-rose-700">â‚¹0</td><td></td></tr></tfoot></table></div></div></div>
      <div id="rental-section-given" style="display:none;"><div class="glass rounded-2xl p-4 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">ğŸ’° Equipment Given to Others</h3><div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3"><input type="text" id="given-name" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Item Name"><input type="number" id="given-quantity" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Quantity" step="any"><input type="text" id="given-client" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Client Name"><input type="number" id="given-rate" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Daily Rate (â‚¹)" step="any"><input type="date" id="given-date" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"></div><button onclick="addGivenRental()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Add Given Rental</button><div class="mt-4 overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white"><th class="px-3 py-2 text-left rounded-l-lg">Item</th><th class="px-3 py-2 text-center">Qty</th><th class="px-3 py-2 text-left">Client</th><th class="px-3 py-2 text-center">From</th><th class="px-3 py-2 text-center">Days</th><th class="px-3 py-2 text-right">Total</th><th class="px-3 py-2 text-center rounded-r-lg">Action</th></tr></thead><tbody id="rentals-given-table"><tr><td colspan="7" class="px-3 py-4 text-center text-gray-400">No rentals given yet</td></tr></tbody><tfoot><tr class="bg-emerald-50"><td colspan="5" class="px-3 py-2 font-bold text-emerald-700">Total Rental Income</td><td id="total-rental-income" class="px-3 py-2 text-right font-bold text-emerald-700">â‚¹0</td><td></td></tr></tfoot></table></div></div></div>
    </div>
    <div id="tab-contractors" class="tab-content" style="display:none;">
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><div class="flex items-center justify-between gap-3"><button onclick="changeViewMonth(-1)" class="px-4 py-2 bg-indigo-100 text-indigo-600 rounded-xl font-medium hover:bg-indigo-200 text-sm">â† Prev</button><div class="text-center"><p class="text-xs text-gray-600">Viewing Period</p><p id="current-period-teams" class="text-base font-bold text-gray-800"></p></div><button onclick="changeViewMonth(1)" class="px-4 py-2 bg-indigo-100 text-indigo-600 rounded-xl font-medium hover:bg-indigo-200 text-sm">Next â†’</button></div></div>
      <div class="glass rounded-2xl p-3 mb-3 shadow-xl"><div class="flex items-center justify-between gap-2 flex-wrap"><p class="text-sm font-semibold text-gray-700">ğŸ“¤ Export & Print Payment Advances</p><div class="flex gap-2"><button onclick="printMonthlyReport()" class="view-ok flex items-center gap-1.5 px-4 py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all active:scale-95">ğŸ–¨ï¸ Print</button><button onclick="exportPaymentsExcel()" class="flex items-center gap-1.5 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all active:scale-95">ğŸ“Š Excel</button></div></div></div>
      <div class="glass rounded-2xl p-4 mb-3 shadow-xl"><h3 class="text-base font-bold text-gray-800 mb-3">â• Add Contractor/Staff</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-3"><input type="text" id="contractor-name" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Name"><select id="contractor-type" class="px-3 py-2 border border-gray-200 rounded-xl bg-white text-sm focus:outline-none focus:border-indigo-400"><option value="Team">Team/Contractor</option><option value="Staff">Staff</option></select><input type="number" id="contractor-total" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Total Contract (Optional)" step="any"><button onclick="addContractor()" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-2 rounded-xl font-semibold text-sm hover:shadow-lg transition-all active:scale-95">Add</button></div></div>
      <div id="contractors-list" class="space-y-4"><p class="text-white/50 text-center py-4">No teams added yet</p></div>
    </div>
  </main>
</div>
<div id="apk-modal" onclick="if(event.target===this)hideApkModal()"><div class="apk-card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;"><div style="display:flex;align-items:center;gap:0.75rem;"><div style="width:44px;height:44px;background:linear-gradient(135deg,#f59e0b,#ea580c);border-radius:12px;display:flex;align-items:center;justify-content:center;"><svg width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3"/></svg></div><div><p style="color:white;font-weight:800;font-size:1rem;margin:0;">Download as APK</p><p style="color:#a5b4fc;font-size:0.72rem;margin:0;">Sanjineer for Android</p></div></div><button onclick="hideApkModal()" style="background:rgba(255,255,255,0.1);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;">âœ•</button></div>
<div style="background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.35);border-radius:0.75rem;padding:0.75rem 1rem;margin-bottom:1rem;display:flex;gap:0.6rem;align-items:flex-start;"><span style="font-size:1.1rem;flex-shrink:0;">ğŸ’¡</span><p style="color:#fcd34d;font-size:0.78rem;margin:0;line-height:1.5;">Web apps can't export a direct APK file. Use one of the free methods below to convert this app into a real Android APK.</p></div>
<div class="apk-step"><div class="apk-step-num">1</div><div><p style="color:white;font-weight:700;font-size:0.85rem;margin:0 0 0.2rem;">PWABuilder <span style="color:#86efac;font-size:0.72rem;font-weight:600;">â­ Easiest</span></p><p style="color:#c4b5fd;font-size:0.76rem;margin:0 0 0.5rem;line-height:1.4;">Upload this HTML file to any free host (GitHub Pages, Netlify), then paste the URL into PWABuilder to get an APK instantly.</p><button class="apk-btn" onclick="window.open('https://www.pwabuilder.com','_blank')" style="background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;font-size:0.8rem;padding:0.6rem;">ğŸŒ Open PWABuilder.com</button></div></div>
<div class="apk-step"><div class="apk-step-num">2</div><div><p style="color:white;font-weight:700;font-size:0.85rem;margin:0 0 0.2rem;">Trusted Web Activity (TWA)</p><p style="color:#c4b5fd;font-size:0.76rem;margin:0 0 0.5rem;line-height:1.4;">Host the app online, then use Google's Bubblewrap tool or PWABuilder to wrap it as an Android APK for Play Store publishing.</p><button class="apk-btn" onclick="window.open('https://github.com/GoogleChromeLabs/bubblewrap','_blank')" style="background:linear-gradient(135deg,#059669,#0d9488);color:white;font-size:0.8rem;padding:0.6rem;">ğŸ”§ Open Bubblewrap (GitHub)</button></div></div>
<div class="apk-step" style="margin-bottom:0;"><div class="apk-step-num">3</div><div style="flex:1;"><p style="color:white;font-weight:700;font-size:0.85rem;margin:0 0 0.2rem;">Install as PWA on Android <span style="color:#fbbf24;font-size:0.72rem;font-weight:600;">âš¡ Instant</span></p><p style="color:#c4b5fd;font-size:0.76rem;margin:0 0 0.5rem;line-height:1.4;">On Android Chrome: tap â‹® menu â†’ "Add to Home Screen". Works offline, looks & feels like a native app!</p><button id="pwa-install-btn" class="apk-btn" onclick="triggerPWAInstall()" style="background:linear-gradient(135deg,#f59e0b,#ea580c);color:white;font-size:0.8rem;padding:0.6rem;">ğŸ“² Install App Now (Android)</button></div></div>
<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.1);"><button class="apk-btn" onclick="downloadHTML()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;font-size:0.82rem;">ğŸ’¾ Download HTML File (to host yourself)</button></div></div></div>
<div id="attendance-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><div class="flex items-center justify-between mb-4"><h3 id="modal-title" class="text-base font-bold text-gray-800">Add Attendance</h3><button onclick="closeAttendanceModal()" class="text-gray-400 hover:text-gray-600 text-xl leading-none">âœ•</button></div><div class="space-y-3"><div><label class="text-xs font-medium text-gray-600">Date</label><input type="date" id="modal-date" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"></div><div><label class="text-xs font-medium text-gray-600">Hours Worked</label><input type="number" id="modal-hours" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Enter hours" step="any" min="0" max="100"></div><div><label class="text-xs font-medium text-gray-600">Advance Payment (Optional)</label><input type="number" id="modal-advance" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Enter advance amount" step="any"></div><button onclick="saveAttendance()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all active:scale-95">Save Attendance</button></div></div></div>
<div id="contractor-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><div class="flex items-center justify-between mb-4"><h3 id="contractor-modal-title" class="text-base font-bold text-gray-800">Add Advance Payment</h3><button onclick="closeContractorModal()" class="text-gray-400 hover:text-gray-600 text-xl leading-none">âœ•</button></div><div class="space-y-3"><div><label class="text-xs font-medium text-gray-600">Date</label><input type="date" id="payment-date" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400"></div><div><label class="text-xs font-medium text-gray-600">Amount</label><input type="number" id="payment-amount" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-400" placeholder="Enter amount" step="any"></div><button onclick="saveContractorPayment()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all active:scale-95">Save Payment</button></div></div></div>
<div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-5 py-2.5 rounded-xl shadow-2xl opacity-0 transition-all duration-300 z-[100] text-sm font-medium pointer-events-none"><span id="toast-message"></span></div>
<div id="delete-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-5 py-2.5 rounded-xl shadow-2xl hidden z-[100] delete-confirm"><div class="flex items-center gap-3 text-sm"><span id="delete-message">Delete this record?</span><button onclick="confirmDelete()" class="px-3 py-1 bg-white text-rose-600 rounded-lg font-semibold hover:bg-rose-50 text-xs">Delete</button></div></div>
<div id="pwa-banner"><div><p class="text-white font-semibold text-sm">ğŸ“² Install App on Android</p><p class="text-indigo-200 text-xs">Add to home screen for offline use</p></div><div class="flex gap-2"><button onclick="installPWA()" class="px-4 py-2 bg-white text-indigo-700 rounded-xl text-sm font-bold hover:bg-indigo-50 transition-all">Install</button><button onclick="dismissPWA()" class="px-3 py-2 text-white/60 hover:text-white text-xs">Dismiss</button></div></div><script>
const DB_KEY = 'construction_manager_data';
function loadData() { try { return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); } catch(e) { return []; } }
function saveData(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
let allData = loadData();
let currentTab = 'dashboard';
let selectedWorkerId = null;
let selectedContractorId = null;
let currentViewMonth = new Date();
let dailyReportDate = new Date();
let deleteTimeout = null;
let pendingDelete = null;
let deferredInstallPrompt = null;
let nextId = parseInt(localStorage.getItem('cm_next_id') || '1');
function genId() { const id = 'rec_' + nextId++; localStorage.setItem('cm_next_id', nextId); return id; }
function showApkModal() { document.getElementById('apk-modal').classList.add('show'); }
function hideApkModal() { document.getElementById('apk-modal').classList.remove('show'); }
function triggerPWAInstall() { if (deferredInstallPrompt) { deferredInstallPrompt.prompt(); deferredInstallPrompt.userChoice.then((c) => { if (c.outcome === 'accepted') { showToast('App installed! ğŸ‰', 'success'); hideApkModal(); } deferredInstallPrompt = null; }); } else { showToast('Open in Chrome on Android, tap â‹® â†’ Add to Home Screen', 'default'); } }
function downloadHTML() { const html = '<!DOCTYPE html>' + document.documentElement.outerHTML; const blob = new Blob([html], { type: 'text/html' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Sanjineer-App.html'; a.click(); URL.revokeObjectURL(a.href); showToast('HTML downloaded!', 'success'); }
let _initDone = false;
function init() {
  if (!_initDone) {
    _initDone = true;
    setupTabs();
    setInterval(updateDate, 60000);
    document.getElementById('daily-report-date').addEventListener('change', (e) => { dailyReportDate = new Date(e.target.value + 'T00:00:00'); const label = dailyReportDate.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); const lbl = document.getElementById('daily-report-label'); if(lbl) lbl.textContent = 'ğŸ“… Selected: ' + label + ' â€” click Load to refresh data'; }, { passive: true });
    document.getElementById('rental-tab-borrowed').addEventListener('click', () => switchRentalTab('borrowed'), { passive: true });
    document.getElementById('rental-tab-given').addEventListener('click', () => switchRentalTab('given'), { passive: true });
  }
  updateDate();
  populateExportMonths();
  const today = new Date();
  ['petty-cash-date','material-date','tool-date','assign-date','rental-date','given-date'].forEach(id => { const el = document.getElementById(id); if (el) el.valueAsDate = today; });
  document.getElementById('daily-report-date').valueAsDate = dailyReportDate;
  switchTab('dashboard');
}
function loadDailyReport() { const input = document.getElementById('daily-report-date'); if(input.value) { dailyReportDate = new Date(input.value + 'T00:00:00'); } const label = dailyReportDate.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); const lbl = document.getElementById('daily-report-label'); if(lbl) lbl.textContent = 'âœ… Showing data for: ' + label; allData = loadData(); updateDailyReport(); showToast('ğŸ“‚ Loaded: ' + label, 'success'); }
function updateDate() { document.getElementById('header-date-inline').textContent = new Date().toLocaleDateString('en-IN', { weekday:'short', day:'numeric', month:'short', year:'numeric' }); }
function setupTabs() { document.querySelectorAll('.tab-btn').forEach(btn => { btn.addEventListener('click', () => switchTab(btn.dataset.tab)); }); }
function switchTab(tabName) { currentTab = tabName; document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active','text-white'); b.classList.add('text-white/70'); }); const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`); if (activeBtn) { activeBtn.classList.remove('text-white/70'); activeBtn.classList.add('text-white','active'); } document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none'); const el = document.getElementById(`tab-${tabName}`); if (el) el.style.display = 'block'; if (tabName === 'rentals') switchRentalTab('borrowed'); updateAllViews(); }
function switchRentalTab(rt) { document.querySelectorAll('.rental-tab-btn').forEach(b => { b.classList.remove('bg-gradient-to-r','from-rose-500','to-pink-500','from-emerald-500','to-teal-500','text-white'); b.classList.add('bg-white/20','text-gray-800'); }); ['borrowed','given'].forEach(s => { const el = document.getElementById(`rental-section-${s}`); if(el) el.style.display='none'; }); if (rt === 'borrowed') { const btn = document.getElementById('rental-tab-borrowed'); btn.classList.remove('bg-white/20','text-gray-800'); btn.classList.add('bg-gradient-to-r','from-rose-500','to-pink-500','text-white'); document.getElementById('rental-section-borrowed').style.display = 'block'; } else { const btn = document.getElementById('rental-tab-given'); btn.classList.remove('bg-white/20','text-gray-800'); btn.classList.add('bg-gradient-to-r','from-emerald-500','to-teal-500','text-white'); document.getElementById('rental-section-given').style.display = 'block'; } }
let _rafPending = false;
function updateAllViews() { allData = loadData(); if (_rafPending) return; _rafPending = true; requestAnimationFrame(() => { _rafPending = false; const views = { dashboard: updateDashboard, daily: updateDailyReport, attendance: updateWorkersList, material: updateMaterialsTable, tools: updateToolsTable, rentals: updateRentalsTable, contractors: updateContractorsList }; if (views[currentTab]) views[currentTab](); updateDropdowns(); }); }
function showToast(msg, type='default') { const t = document.getElementById('toast'); t.textContent = msg; t.style.background = type==='error'?'#dc2626':type==='success'?'#059669':'#1f2937'; t.style.opacity = '1'; t.style.transform = 'translate(-50%,0)'; setTimeout(() => { t.style.opacity='0'; }, 2800); }
function showDeleteConfirmation(message, fn) { if (deleteTimeout) clearTimeout(deleteTimeout); pendingDelete = fn; document.getElementById('delete-message').textContent = message; document.getElementById('delete-toast').classList.remove('hidden'); deleteTimeout = setTimeout(() => { document.getElementById('delete-toast').classList.add('hidden'); pendingDelete = null; }, 3500); }
function confirmDelete() { if (pendingDelete) { document.getElementById('delete-toast').classList.add('hidden'); clearTimeout(deleteTimeout); pendingDelete(); pendingDelete = null; } }
function fmtCur(n) { return 'â‚¹' + (n||0).toLocaleString('en-IN', { maximumFractionDigits:2 }); }
function getToday() { return new Date().toISOString().split('T')[0]; }
function getCurrentMonth() { const n=new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`; }
function getMonthString(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function formatMonthYear(d) { return ['January','February','March','April','May','June','July','August','September','October','November','December'][d.getMonth()] + ' ' + d.getFullYear(); }
function changeViewMonth(delta) { currentViewMonth = new Date(currentViewMonth.getFullYear(), currentViewMonth.getMonth()+delta, 1); updateContractorsList(); }
function daysBetween(d1, d2) { return Math.ceil(Math.abs(new Date(d2)-new Date(d1))/(86400000))+1; }
function populateExportMonths() { const now = new Date(); ['export-month-select','print-month-select'].forEach(id => { const sel = document.getElementById(id); if (!sel) return; sel.innerHTML = ''; for (let i = 0; i < 12; i++) { const d = new Date(now.getFullYear(), now.getMonth()-i, 1); const val = getMonthString(d); const opt = document.createElement('option'); opt.value = val; opt.textContent = formatMonthYear(d); if (i===0) opt.selected = true; sel.appendChild(opt); } }); }
function createRecord(obj) { const record = { ...obj, __id: genId(), __created: new Date().toISOString() }; allData.push(record); saveData(allData); return record; }
function updateRecord(id, updates) { const idx = allData.findIndex(d => d.__id === id); if (idx>=0) { allData[idx] = {...allData[idx], ...updates}; saveData(allData); return allData[idx]; } }
function deleteRecord(id) { allData = allData.filter(d => d.__id !== id); saveData(allData); }
function addWorker() { const name = document.getElementById('worker-name').value.trim(); const category = document.getElementById('worker-category').value; const team = document.getElementById('worker-team-select').value; const wage = parseFloat(document.getElementById('worker-wage').value)||0; if (!name||!category||!team) { showToast('Please fill all fields','error'); return; } createRecord({ type:'worker', name, category, team_name:team, hourly_wage:wage }); document.getElementById('worker-name').value=''; document.getElementById('worker-category').value=''; document.getElementById('worker-team-select').value=''; document.getElementById('worker-wage').value=''; showToast('Worker added','success'); updateAllViews(); }
function deleteWorker(id) { const w = allData.find(d=>d.__id===id); if(!w) return; showDeleteConfirmation(`Delete worker ${w.name}?`, ()=>{ deleteRecord(id); showToast('Worker deleted'); updateAllViews(); }); }
function addPettyCash() { const amount = parseFloat(document.getElementById('petty-cash-amount').value)||0; const date = document.getElementById('petty-cash-date').value; if(!amount||!date){showToast('Enter amount and date','error');return;} createRecord({type:'material',material_name:'Petty Cash Deposit',quantity:0,cost:amount,date,is_petty_cash:true}); document.getElementById('petty-cash-amount').value=''; showToast('Petty cash deposited','success'); updateAllViews(); }
function addMaterial() { const name = document.getElementById('material-name').value.trim(); const quantity = parseFloat(document.getElementById('material-quantity').value)||0; const cost = parseFloat(document.getElementById('material-cost').value)||0; const date = document.getElementById('material-date').value; if(!name||!date){showToast('Enter material name and date','error');return;} createRecord({type:'material',material_name:name,quantity,cost,date,is_petty_cash:false}); document.getElementById('material-name').value=''; document.getElementById('material-quantity').value=''; document.getElementById('material-cost').value=''; showToast('Material added','success'); updateAllViews(); }
function deleteMaterial(id) { const m = allData.find(d=>d.__id===id); showDeleteConfirmation(`Delete ${m?.material_name}?`,()=>{ deleteRecord(id); showToast('Deleted'); updateAllViews(); }); }
function addTool() { const name = document.getElementById('tool-name').value.trim(); const quantity = parseFloat(document.getElementById('tool-quantity').value)||0; const date = document.getElementById('tool-date').value; const cost = parseFloat(document.getElementById('tool-cost').value)||0; if(!name){showToast('Enter tool name','error');return;} createRecord({type:'tool',tool_name:name,tool_quantity:quantity,purchase_date:date,purchase_cost:cost}); document.getElementById('tool-name').value=''; document.getElementById('tool-quantity').value=''; document.getElementById('tool-cost').value=''; showToast('Tool added','success'); updateAllViews(); }
function deleteTool(id) { const t = allData.find(d=>d.__id===id); showDeleteConfirmation(`Delete ${t?.tool_name}?`,()=>{ deleteRecord(id); showToast('Deleted'); updateAllViews(); }); }
function assignTool() { const toolId = document.getElementById('assign-tool').value; const workerId = document.getElementById('assign-worker').value; const date = document.getElementById('assign-date').value; if(!toolId||!workerId){showToast('Select tool and worker','error');return;} const tool = allData.find(d=>d.__id===toolId); const worker = allData.find(d=>d.__id===workerId); createRecord({type:'tool_assignment',tool_name:tool.tool_name,assigned_to:worker.name,assigned_date:date}); showToast('Tool assigned','success'); updateAllViews(); }
function addRental() { const name = document.getElementById('rental-name').value.trim(); const qty = parseFloat(document.getElementById('rental-quantity').value)||0; const rate = parseFloat(document.getElementById('rental-rate').value)||0; const date = document.getElementById('rental-date').value; if(!name||!date){showToast('Enter name and date','error');return;} createRecord({type:'rental',rental_name:name,rental_quantity:qty,daily_rate:rate,borrowed_date:date,is_given:false}); document.getElementById('rental-name').value=''; document.getElementById('rental-quantity').value=''; document.getElementById('rental-rate').value=''; showToast('Rental added','success'); updateAllViews(); }
function addGivenRental() { const name = document.getElementById('given-name').value.trim(); const qty = parseFloat(document.getElementById('given-quantity').value)||0; const client = document.getElementById('given-client').value.trim(); const rate = parseFloat(document.getElementById('given-rate').value)||0; const date = document.getElementById('given-date').value; if(!name||!client||!date){showToast('Enter all required fields','error');return;} createRecord({type:'rental',rental_name:name,rental_quantity:qty,client_name:client,daily_rate:rate,borrowed_date:date,is_given:true}); document.getElementById('given-name').value=''; document.getElementById('given-quantity').value=''; document.getElementById('given-client').value=''; document.getElementById('given-rate').value=''; showToast('Rental added','success'); updateAllViews(); }
function deleteRental(id) { const r = allData.find(d=>d.__id===id); showDeleteConfirmation(`Delete ${r?.rental_name}?`,()=>{ deleteRecord(id); showToast('Deleted'); updateAllViews(); }); }
function addContractor() { const name = document.getElementById('contractor-name').value.trim(); const type = document.getElementById('contractor-type').value; const total = parseFloat(document.getElementById('contractor-total').value)||0; if(!name){showToast('Enter name','error');return;} createRecord({type:'contractor',contractor_name:name,contractor_type:type,total_contract:total}); document.getElementById('contractor-name').value=''; document.getElementById('contractor-total').value=''; showToast(`${type} added`,'success'); updateAllViews(); }
function deleteContractor(id) { const c = allData.find(d=>d.__id===id); showDeleteConfirmation(`Delete ${c?.contractor_name}?`,()=>{ deleteRecord(id); showToast('Deleted'); updateAllViews(); }); }
function openContractorPaymentModal(cId) { selectedContractorId = cId; const c = allData.find(d=>d.__id===cId); document.getElementById('contractor-modal-title').textContent = `Add Advance - ${c.contractor_name}`; document.getElementById('payment-date').valueAsDate = new Date(); document.getElementById('payment-amount').value = ''; document.getElementById('contractor-modal').classList.remove('hidden'); }
function closeContractorModal() { document.getElementById('contractor-modal').classList.add('hidden'); selectedContractorId=null; }
function saveContractorPayment() { const date = document.getElementById('payment-date').value; const amount = parseFloat(document.getElementById('payment-amount').value)||0; if(!amount||!selectedContractorId){showToast('Enter payment amount','error');return;} const c = allData.find(d=>d.__id===selectedContractorId); createRecord({type:'contractor_payment',contractor_name:c.contractor_name,payment:amount,date}); closeContractorModal(); showToast('Payment added','success'); updateAllViews(); }
function deleteContractorPayment(id) { showDeleteConfirmation('Delete this payment?',()=>{ deleteRecord(id); showToast('Deleted'); updateAllViews(); }); }
function openAttendanceModal(workerId, date) { selectedWorkerId = workerId; const worker = allData.find(d=>d.__id===workerId); const existing = allData.filter(d=>d.type==='attendance'&&d.name===worker.name&&d.date===(date||getToday())); const att = existing.length ? existing[existing.length-1] : null; document.getElementById('modal-title').textContent = `Attendance - ${worker.name}`; document.getElementById('modal-date').value = date||getToday(); document.getElementById('modal-hours').value = att?att.hours:''; document.getElementById('modal-advance').value = att?(att.advance||''):''; document.getElementById('attendance-modal').classList.remove('hidden'); }
function closeAttendanceModal() { document.getElementById('attendance-modal').classList.add('hidden'); selectedWorkerId=null; }
function saveAttendance() { const date = document.getElementById('modal-date').value; const hours = parseFloat(document.getElementById('modal-hours').value)||0; const advance = parseFloat(document.getElementById('modal-advance').value)||0; if(!selectedWorkerId){showToast('Invalid worker','error');return;} if(hours<0||hours>100){showToast('Hours must be 0-100','error');return;} const worker = allData.find(d=>d.__id===selectedWorkerId); const existing = allData.filter(d=>d.type==='attendance'&&d.name===worker.name&&d.date===date); if (existing.length) { updateRecord(existing[existing.length-1].__id,{hours,advance,payment:hours*worker.hourly_wage}); } else { createRecord({type:'attendance',name:worker.name,category:worker.category,date,hours,advance,payment:hours*worker.hourly_wage,hourly_wage:worker.hourly_wage}); } closeAttendanceModal(); showToast('Attendance saved','success'); updateAllViews(); }function dedupeAtt(list) { const m={}; list.forEach(a=>{ const k=`${a.name}_${a.date}`; if(!m[k]||a.__id>m[k].__id) m[k]=a; }); return Object.values(m); }
function updateDashboard() { const cm = getCurrentMonth(); const today = getToday(); const att = allData.filter(d=>d.type==='attendance'&&d.date&&d.date.startsWith(cm)); const uniqAtt = dedupeAtt(att); const workerAdv = uniqAtt.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const contAdv = allData.filter(d=>d.type==='contractor_payment'&&d.date&&d.date.startsWith(cm)).reduce((s,d)=>s+(parseFloat(d.payment)||0),0); const totalAdv = workerAdv+contAdv; const workerPay = uniqAtt.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const contContr = allData.filter(d=>d.type==='contractor').reduce((s,c)=>s+(parseFloat(c.total_contract)||0),0); const totalPay = workerPay+contContr; const matCost = allData.filter(d=>d.type==='material'&&!d.is_petty_cash&&d.date&&d.date.startsWith(cm)).reduce((s,d)=>s+(parseFloat(d.cost)||0),0); const pettyIn = allData.filter(d=>d.type==='material'&&d.is_petty_cash).reduce((s,d)=>s+(parseFloat(d.cost)||0),0); const pettyOut = allData.filter(d=>d.type==='material'&&!d.is_petty_cash).reduce((s,d)=>s+(parseFloat(d.cost)||0),0); const rentalExp = allData.filter(d=>d.type==='rental'&&!d.is_given).reduce((s,r)=>{const days=daysBetween(r.borrowed_date,today);return s+days*(parseFloat(r.daily_rate)||0)*(parseFloat(r.rental_quantity)||1);},0); const rentalInc = allData.filter(d=>d.type==='rental'&&d.is_given).reduce((s,r)=>{const days=daysBetween(r.borrowed_date,today);return s+days*(parseFloat(r.daily_rate)||0)*(parseFloat(r.rental_quantity)||1);},0); const allAtt = dedupeAtt(allData.filter(d=>d.type==='attendance')); const totalWPay = allAtt.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const totalMatAll = allData.filter(d=>d.type==='material'&&!d.is_petty_cash).reduce((s,d)=>s+(parseFloat(d.cost)||0),0); document.getElementById('dash-advance').textContent=fmtCur(totalAdv); document.getElementById('dash-remaining').textContent=fmtCur(Math.max(0,totalPay-totalAdv)); document.getElementById('dash-material').textContent=fmtCur(matCost); document.getElementById('dash-petty').textContent=fmtCur(pettyIn); document.getElementById('dash-petty-remaining').textContent=fmtCur(pettyIn-pettyOut); document.getElementById('dash-rental-out').textContent=fmtCur(rentalExp); document.getElementById('dash-rental-in').textContent=fmtCur(rentalInc); document.getElementById('header-spends').textContent=fmtCur(totalWPay+totalMatAll+rentalExp); updateTeamDetails(); }
function updateTeamDetails() { const cm = getCurrentMonth(); const contractors = allData.filter(d=>d.type==='contractor'); const div = document.getElementById('team-details'); if(!contractors.length){div.innerHTML='<p class="text-gray-400 text-center py-3 text-sm">No teams added yet</p>';return;} div.innerHTML = contractors.map(c=>{ const tw = allData.filter(d=>d.type==='worker'&&d.team_name===c.contractor_name); const ta = dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.date&&d.date.startsWith(cm)&&tw.some(w=>w.name===d.name))); const pay=ta.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0)+(parseFloat(c.total_contract)||0); const adv=ta.reduce((s,a)=>s+(parseFloat(a.advance)||0),0)+allData.filter(d=>d.type==='contractor_payment'&&d.contractor_name===c.contractor_name&&d.date&&d.date.startsWith(cm)).reduce((s,p)=>s+(parseFloat(p.payment)||0),0); const bal=pay-adv; return `<div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-3 border border-indigo-100"><div class="flex items-center justify-between mb-2"><div><h4 class="font-bold text-gray-800 text-sm">${c.contractor_name}</h4><p class="text-[10px] text-gray-500">${tw.length} workers</p></div><div class="text-right"><p class="text-[10px] text-gray-500">Balance</p><p class="text-base font-bold ${bal>=0?'text-emerald-600':'text-rose-600'}">${fmtCur(bal)}</p></div></div><div class="grid grid-cols-2 gap-2"><div class="bg-white rounded-lg p-2 text-center"><p class="text-[10px] text-blue-500">Payment</p><p class="font-bold text-sm text-blue-700">${fmtCur(pay)}</p></div><div class="bg-white rounded-lg p-2 text-center"><p class="text-[10px] text-amber-500">Advances</p><p class="font-bold text-sm text-amber-700">${fmtCur(adv)}</p></div></div></div>`; }).join(''); }
function updateDailyReport() { const sel = dailyReportDate.toISOString().split('T')[0]; const att = dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.date===sel)); const wAdv = att.reduce((s,d)=>s+(parseFloat(d.advance)||0),0); const cAdv = allData.filter(d=>d.type==='contractor_payment'&&d.date===sel).reduce((s,d)=>s+(parseFloat(d.payment)||0),0); document.getElementById('daily-payments').textContent = fmtCur(wAdv+cAdv); const mats = allData.filter(d=>d.type==='material'&&d.date===sel&&!d.is_petty_cash); document.getElementById('daily-material').textContent = fmtCur(mats.reduce((s,d)=>s+(parseFloat(d.cost)||0),0)); const matTable = document.getElementById('daily-materials-table'); matTable.innerHTML = mats.length ? mats.map(m=>`<tr class="hover:bg-gray-50"><td class="px-3 py-2 font-medium text-gray-700">${m.material_name}</td><td class="px-3 py-2 text-center">${m.quantity||'-'}</td><td class="px-3 py-2 text-right font-medium">${fmtCur(m.cost)}</td></tr>`).join('') : '<tr><td colspan="3" class="px-3 py-4 text-center text-gray-400">No materials purchased</td></tr>'; const labTable = document.getElementById('daily-labour-table'); if(!att.length){labTable.innerHTML='<tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">No attendance recorded</td></tr>';return;} const grp={}; att.forEach(a=>{ if(!grp[a.category]) grp[a.category]=[]; grp[a.category].push(a); }); const order=['Mason','Labour','Carpenter','Helper','Fitter','Fitter Helper','Supervisor']; const sorted = Object.keys(grp).sort((a,b)=>(order.indexOf(a)+1||999)-(order.indexOf(b)+1||999)); labTable.innerHTML = sorted.map(cat=>{ const wks=grp[cat]; const hrs=wks.reduce((s,w)=>s+(parseFloat(w.hours)||0),0); const wd=wks[0].work_done||'-'; return `<tr class="hover:bg-gray-50" data-category="${cat}"><td class="px-3 py-2 font-bold text-gray-800">${cat}</td><td class="px-3 py-2 text-center font-bold text-indigo-600">${wks.length}</td><td class="px-3 py-2 text-center font-bold">${hrs.toFixed(1)}h</td><td class="px-3 py-2 text-gray-700 work-done-cell">${wd}</td><td class="px-3 py-2 text-center no-print"><button onclick="editWorkDone('${cat}')" class="px-3 py-1 bg-indigo-100 text-indigo-600 hover:bg-indigo-200 rounded-lg text-xs font-medium">Edit</button></td></tr>`; }).join(''); }
function editWorkDone(category) { const row = document.querySelector(`[data-category="${category}"]`); if(!row) return; const cell = row.querySelector('.work-done-cell'); const cur = cell.textContent.trim(); cell.innerHTML = `<div class="flex gap-2 items-center"><input type="text" id="wd-inp-${category}" class="flex-1 px-2 py-1 border border-indigo-300 rounded-lg text-xs" value="${cur==='-'?'':cur}"><button onclick="saveWorkDone('${category}')" class="px-2 py-1 bg-emerald-500 text-white rounded-lg text-xs">Save</button><button onclick="updateDailyReport()" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-lg text-xs">âœ•</button></div>`; document.getElementById(`wd-inp-${category}`)?.focus(); }
function saveWorkDone(category) { const sel = dailyReportDate.toISOString().split('T')[0]; const val = document.getElementById(`wd-inp-${category}`)?.value?.trim()||''; const toUpdate = dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.date===sel&&d.category===category)); toUpdate.forEach(a=>updateRecord(a.__id,{work_done:val})); showToast('Work description saved','success'); updateDailyReport(); }
function updateWorkersList() { const workers = allData.filter(d=>d.type==='worker'); const div = document.getElementById('workers-list'); if(!workers.length){div.innerHTML='<p class="text-gray-400 text-center py-4">No workers added yet</p>';return;} const order=['Mason','Labour','Carpenter','Helper','Fitter','Fitter Helper','Supervisor']; const grp={}; workers.forEach(w=>{ if(!grp[w.category]) grp[w.category]=[]; grp[w.category].push(w); }); const sorted = Object.keys(grp).sort((a,b)=>(order.indexOf(a)+1||999)-(order.indexOf(b)+1||999)); const cm=getCurrentMonth(); div.innerHTML = sorted.map(cat=>{ return `<div class="mb-4"><h4 class="text-sm font-bold text-indigo-600 mb-2 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-indigo-500 inline-block"></span>${cat} (${grp[cat].length})</h4><div class="space-y-2">${grp[cat].map(w=>{ const mAtt=dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.name===w.name&&d.date&&d.date.startsWith(cm))); const totalDays=mAtt.filter(a=>parseFloat(a.hours)>0).length; const totalHrs=mAtt.reduce((s,a)=>s+(parseFloat(a.hours)||0),0); const totalAdv=mAtt.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const totalPay=mAtt.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); return `<div class="bg-gray-50 rounded-xl p-3"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">${w.name.charAt(0).toUpperCase()}</div><div><p class="font-medium text-gray-800 text-sm">${w.name}</p><p class="text-xs text-gray-500">${fmtCur(w.hourly_wage)}/hr${w.team_name?' Â· '+w.team_name:''}</p></div></div><div class="flex gap-1.5"><button onclick="toggleWorkerCalendar('${w.__id}')" class="px-2 py-1 bg-indigo-100 text-indigo-600 rounded-lg text-xs font-medium hover:bg-indigo-200">ğŸ“…</button><button onclick="deleteWorker('${w.__id}')" class="px-2 py-1 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded-lg text-xs font-medium">Del</button></div></div><div class="grid grid-cols-4 gap-2 mt-2.5 text-center"><div class="bg-white rounded-lg p-1.5"><p class="text-[10px] text-gray-400">Days</p><p class="font-bold text-gray-800 text-sm">${totalDays}</p></div><div class="bg-white rounded-lg p-1.5"><p class="text-[10px] text-gray-400">Hours</p><p class="font-bold text-gray-800 text-sm">${totalHrs.toFixed(1)}</p></div><div class="bg-white rounded-lg p-1.5"><p class="text-[10px] text-amber-500">Advances</p><p class="font-bold text-amber-600 text-sm">${fmtCur(totalAdv)}</p></div><div class="bg-white rounded-lg p-1.5"><p class="text-[10px] text-emerald-500">Pay Due</p><p class="font-bold text-emerald-600 text-sm">${fmtCur(totalPay)}</p></div></div><div id="calendar-${w.__id}" class="expand-content mt-3"><div id="calendar-content-${w.__id}">${renderWorkerCalendar(w, new Date())}</div></div></div>`; }).join('')}</div></div>`; }).join(''); }
function toggleWorkerCalendar(wId) { document.getElementById(`calendar-${wId}`)?.classList.toggle('expanded'); }
function renderWorkerCalendar(worker, viewDate) { const yr=viewDate.getFullYear(), mo=viewDate.getMonth(); const fd=new Date(yr,mo,1).getDay(), days=new Date(yr,mo+1,0).getDate(); const ms=`${yr}-${String(mo+1).padStart(2,'0')}`; const attMap={}; allData.filter(d=>d.type==='attendance'&&d.name===worker.name&&d.date&&d.date.startsWith(ms)).forEach(a=>{if(!attMap[a.date]||a.__id>attMap[a.date].__id) attMap[a.date]=a;}); const uniq=Object.values(attMap); const tDays=uniq.filter(a=>parseFloat(a.hours)>0).length; const tHrs=uniq.reduce((s,a)=>s+(parseFloat(a.hours)||0),0); const tAdv=uniq.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const tPay=uniq.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const months=['January','February','March','April','May','June','July','August','September','October','November','December']; const dayCells = Array(fd).fill('<div class="h-14"></div>').join('') + Array.from({length:days},(_,i)=>{ const d=i+1, ds=`${yr}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const a=attMap[ds]; const isToday=ds===getToday(); const isPast=new Date(ds)<new Date(getToday()); const bg=a?(parseFloat(a.hours)===0?'bg-rose-100 text-rose-600':'bg-emerald-500 text-white'):isToday?'bg-indigo-100 text-indigo-600':isPast?'bg-rose-100 text-rose-400':'hover:bg-gray-100 text-gray-600'; return `<div onclick="openAttendanceModal('${worker.__id}','${ds}')" class="calendar-day flex flex-col items-center justify-center rounded-lg p-1 ${bg}${a?' font-bold':''}" title="${a?a.hours+'h':'No attendance'}"><div class="text-xs">${d}</div>${a?`<div class="text-[9px] leading-tight">${parseFloat(a.hours).toFixed(1)}h${a.advance?'<br>â‚¹'+parseFloat(a.advance):''}</div>`:''}</div>`; }).join(''); return `<div class="bg-white rounded-xl p-3"><div class="flex items-center justify-between mb-2"><button onclick="changeWorkerCalendarMonth('${worker.__id}',-1,${yr},${mo})" class="px-2 py-1 bg-indigo-100 text-indigo-600 rounded-lg text-xs font-medium">â† Prev</button><p class="font-bold text-gray-700 text-sm">${months[mo]} ${yr}</p><button onclick="changeWorkerCalendarMonth('${worker.__id}',1,${yr},${mo})" class="px-2 py-1 bg-indigo-100 text-indigo-600 rounded-lg text-xs font-medium">Next â†’</button></div><div class="grid grid-cols-4 gap-2 mb-2"><div class="bg-blue-50 rounded-lg p-1.5 text-center"><p class="text-[10px] text-blue-500">Days</p><p class="font-bold text-blue-700 text-sm">${tDays}</p></div><div class="bg-purple-50 rounded-lg p-1.5 text-center"><p class="text-[10px] text-purple-500">Hrs</p><p class="font-bold text-purple-700 text-sm">${tHrs.toFixed(1)}</p></div><div class="bg-amber-50 rounded-lg p-1.5 text-center"><p class="text-[10px] text-amber-500">Adv</p><p class="font-bold text-amber-700 text-sm">${fmtCur(tAdv)}</p></div><div class="bg-emerald-50 rounded-lg p-1.5 text-center"><p class="text-[10px] text-emerald-500">Pay</p><p class="font-bold text-emerald-700 text-sm">${fmtCur(tPay)}</p></div></div><div class="grid grid-cols-7 gap-0.5 text-center text-[10px] mb-1">${'SMTWTFS'.split('').map(d=>`<div class="font-medium text-gray-400">${d}</div>`).join('')}</div><div class="grid grid-cols-7 gap-0.5">${dayCells}</div></div>`; }
function changeWorkerCalendarMonth(wId, delta, yr, mo) { const w = allData.find(d=>d.__id===wId); if(!w) return; const nd = new Date(yr, mo+delta, 1); const cc = document.getElementById(`calendar-content-${wId}`); if(cc) cc.innerHTML = renderWorkerCalendar(w, nd); }
function updateMaterialsTable() { const mats = allData.filter(d=>d.type==='material'); const tMat=mats.filter(m=>!m.is_petty_cash).reduce((s,m)=>s+(parseFloat(m.cost)||0),0); const tPetty=mats.filter(m=>m.is_petty_cash).reduce((s,m)=>s+(parseFloat(m.cost)||0),0); document.getElementById('total-material-cost').textContent=fmtCur(tMat); document.getElementById('total-petty-cash').textContent=fmtCur(tPetty); document.getElementById('remaining-petty-cash').textContent=fmtCur(tPetty-tMat); const tb = document.getElementById('materials-table'); tb.innerHTML = mats.length ? mats.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(m=>`<tr class="hover:bg-gray-50 ${m.is_petty_cash?'bg-cyan-50':''}"><td class="px-3 py-2 text-gray-500 text-xs">${m.date||'-'}</td><td class="px-3 py-2 font-medium text-gray-700 text-sm">${m.material_name}${m.is_petty_cash?'<span class="ml-1 text-[10px] bg-cyan-100 text-cyan-600 px-1.5 py-0.5 rounded-full">Petty Cash</span>':''}</td><td class="px-3 py-2 text-center text-sm">${m.quantity||'-'}</td><td class="px-3 py-2 text-right font-medium text-sm">${fmtCur(m.cost)}</td><td class="px-3 py-2 text-center"><button onclick="deleteMaterial('${m.__id}')" class="px-2 py-1 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded-lg text-xs font-medium">Del</button></td></tr>`).join('') : '<tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">No materials added yet</td></tr>'; }
function updateToolsTable() { const tools=allData.filter(d=>d.type==='tool'); const tb=document.getElementById('tools-table'); tb.innerHTML=tools.length?tools.map(t=>`<tr class="hover:bg-gray-50"><td class="px-3 py-2 font-medium text-gray-700 text-sm">${t.tool_name}</td><td class="px-3 py-2 text-center text-sm">${t.tool_quantity||1}</td><td class="px-3 py-2 text-center text-gray-500 text-xs">${t.purchase_date||'-'}</td><td class="px-3 py-2 text-right text-sm">${t.purchase_cost?fmtCur(t.purchase_cost):'-'}</td><td class="px-3 py-2 text-center"><button onclick="deleteTool('${t.__id}')" class="px-2 py-1 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded-lg text-xs font-medium">Del</button></td></tr>`).join(''):'<tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">No tools added yet</td></tr>'; const assign=allData.filter(d=>d.type==='tool_assignment'); const ad=document.getElementById('tool-assignments'); ad.innerHTML=assign.length?assign.map(a=>`<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl text-sm"><div><p class="font-medium text-gray-700">${a.tool_name}</p><p class="text-xs text-gray-400">Assigned to: ${a.assigned_to} Â· ${a.assigned_date}</p></div></div>`).join(''):'<p class="text-gray-400 text-center py-4 text-sm">No tool assignments</p>'; }
function updateRentalsTable() { const today=getToday(); const borrow=allData.filter(d=>d.type==='rental'&&!d.is_given); let tExp=0; const bTb=document.getElementById('rentals-borrowed-table'); bTb.innerHTML=borrow.length?borrow.map(r=>{const days=daysBetween(r.borrowed_date,today),rate=parseFloat(r.daily_rate)||0,qty=parseFloat(r.rental_quantity)||1,tot=days*rate*qty;tExp+=tot;return`<tr class="hover:bg-gray-50"><td class="px-3 py-2 font-medium text-gray-700 text-sm">${r.rental_name}</td><td class="px-3 py-2 text-center text-sm">${r.rental_quantity||1}</td><td class="px-3 py-2 text-center text-xs text-gray-500">${r.borrowed_date}</td><td class="px-3 py-2 text-center text-sm">${days}</td><td class="px-3 py-2 text-right font-medium text-rose-600 text-sm">${fmtCur(tot)}</td><td class="px-3 py-2 text-center"><button onclick="deleteRental('${r.__id}')" class="px-2 py-1 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded-lg text-xs">Del</button></td></tr>`;}).join(''):'<tr><td colspan="6" class="px-3 py-4 text-center text-gray-400">No rentals yet</td></tr>'; document.getElementById('total-rental-expense').textContent=fmtCur(tExp); const given=allData.filter(d=>d.type==='rental'&&d.is_given); let tInc=0; const gTb=document.getElementById('rentals-given-table'); gTb.innerHTML=given.length?given.map(r=>{const days=daysBetween(r.borrowed_date,today),rate=parseFloat(r.daily_rate)||0,qty=parseFloat(r.rental_quantity)||1,tot=days*rate*qty;tInc+=tot;return`<tr class="hover:bg-gray-50"><td class="px-3 py-2 font-medium text-gray-700 text-sm">${r.rental_name}</td><td class="px-3 py-2 text-center text-sm">${r.rental_quantity||1}</td><td class="px-3 py-2 text-sm">${r.client_name||'-'}</td><td class="px-3 py-2 text-center text-xs text-gray-500">${r.borrowed_date}</td><td class="px-3 py-2 text-center text-sm">${days}</td><td class="px-3 py-2 text-right font-medium text-emerald-600 text-sm">${fmtCur(tot)}</td><td class="px-3 py-2 text-center"><button onclick="deleteRental('${r.__id}')" class="px-2 py-1 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded-lg text-xs">Del</button></td></tr>`;}).join(''):'<tr><td colspan="7" class="px-3 py-4 text-center text-gray-400">No rentals given yet</td></tr>'; document.getElementById('total-rental-income').textContent=fmtCur(tInc); }function updateContractorsList() { document.getElementById('current-period-teams').textContent=formatMonthYear(currentViewMonth); const vms=getMonthString(currentViewMonth); const contractors=allData.filter(d=>d.type==='contractor'); const div=document.getElementById('contractors-list'); if(!contractors.length){div.innerHTML='<p class="text-white/50 text-center py-4">No contractors/staff added yet</p>';return;} div.innerHTML=contractors.map(c=>{ const tw=allData.filter(d=>d.type==='worker'&&d.team_name===c.contractor_name); const ta=dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.date&&d.date.startsWith(vms)&&tw.some(w=>w.name===d.name))); const wPay=ta.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const wAdv=ta.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const payments=allData.filter(d=>d.type==='contractor_payment'&&d.contractor_name===c.contractor_name&&d.date&&d.date.startsWith(vms)); const cPay=payments.reduce((s,p)=>s+(parseFloat(p.payment)||0),0); const totalPay=wPay+(parseFloat(c.total_contract)||0); const totalAdv=wAdv+cPay; const bal=totalPay-totalAdv; return `<div class="glass rounded-2xl p-4 shadow-xl"><div class="flex items-center justify-between mb-3 flex-wrap gap-2"><div class="flex items-center gap-3"><div class="w-11 h-11 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-lg font-bold">${c.contractor_name.charAt(0).toUpperCase()}</div><div><h4 class="font-bold text-gray-800">${c.contractor_name}</h4><p class="text-xs text-gray-500">${c.contractor_type||'Team'} Â· Balance: <span class="font-semibold ${bal>=0?'text-emerald-600':'text-rose-600'}">${fmtCur(bal)}</span></p></div></div><div class="flex gap-2"><button onclick="openContractorPaymentModal('${c.__id}')" class="px-3 py-1.5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl text-xs font-semibold hover:shadow-lg transition-all">+ Payment</button><button onclick="deleteContractor('${c.__id}')" class="px-3 py-1.5 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded-xl text-xs font-medium">Delete</button></div></div><div class="grid grid-cols-3 gap-2 mb-3"><div class="bg-blue-50 rounded-xl p-2.5 text-center"><p class="text-[10px] text-blue-500">Payment</p><p class="text-base font-bold text-blue-700">${fmtCur(totalPay)}</p></div><div class="bg-amber-50 rounded-xl p-2.5 text-center"><p class="text-[10px] text-amber-500">Advances</p><p class="text-base font-bold text-amber-700">${fmtCur(totalAdv)}</p></div><div class="${bal>=0?'bg-emerald-50':'bg-rose-50'} rounded-xl p-2.5 text-center"><p class="text-[10px] ${bal>=0?'text-emerald-500':'text-rose-500'}">Balance</p><p class="text-base font-bold ${bal>=0?'text-emerald-700':'text-rose-700'}">${fmtCur(bal)}</p></div></div>${tw.length?`<div class="bg-gray-50 rounded-xl p-2.5 mb-3"><p class="text-xs font-medium text-gray-500 mb-2">Team Members (${tw.length})</p><div class="grid grid-cols-2 gap-1.5">${tw.map(w=>`<div class="bg-white rounded-lg p-2"><p class="font-medium text-gray-700 text-xs">${w.name}</p><p class="text-[10px] text-gray-400">${w.category} Â· ${fmtCur(w.hourly_wage)}/hr</p></div>`).join('')}</div></div>`:''}${payments.length?`<div class="bg-gray-50 rounded-xl p-2.5"><p class="text-xs font-medium text-gray-500 mb-2">Payment History</p><table class="w-full text-xs"><thead><tr class="border-b border-gray-200"><th class="text-left py-1.5 text-gray-500">Date</th><th class="text-right py-1.5 text-gray-500">Amount</th><th class="text-center py-1.5 text-gray-500">Del</th></tr></thead><tbody>${payments.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(p=>`<tr class="border-b border-gray-100"><td class="py-1.5 text-gray-600">${p.date}</td><td class="py-1.5 text-right font-medium text-gray-800">${fmtCur(p.payment)}</td><td class="py-1.5 text-center"><button onclick="deleteContractorPayment('${p.__id}')" class="px-2 py-0.5 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded text-[10px]">Del</button></td></tr>`).join('')}</tbody></table></div>`:'<p class="text-gray-400 text-center text-xs mt-2">No payments recorded</p>'}</div>`; }).join(''); }
function updateDropdowns() { const tools=allData.filter(d=>d.type==='tool'); document.getElementById('assign-tool').innerHTML='<option value="">Select Tool</option>'+tools.map(t=>`<option value="${t.__id}">${t.tool_name}</option>`).join(''); const workers=allData.filter(d=>d.type==='worker'); document.getElementById('assign-worker').innerHTML='<option value="">Select Worker</option>'+workers.map(w=>`<option value="${w.__id}">${w.name} (${w.category})</option>`).join(''); const teams=allData.filter(d=>d.type==='contractor'); document.getElementById('worker-team-select').innerHTML='<option value="">Select Team</option>'+teams.map(t=>`<option value="${t.contractor_name}">${t.contractor_name}</option>`).join(''); }
function getPrintStyles() { return `* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Arial,sans-serif; } body { background:#fff; color:#1f2937; font-size:12px; padding:20px 24px; } .no-print-bar { position:fixed; top:0; left:0; right:0; background:#4f46e5; color:white; display:flex; align-items:center; gap:12px; padding:10px 16px; z-index:9999; box-shadow:0 2px 8px rgba(0,0,0,0.3); } .no-print-bar button { padding:6px 14px; border-radius:8px; border:none; cursor:pointer; font-size:12px; font-weight:700; } .btn-back { background:rgba(255,255,255,0.2); color:white; } .btn-print { background:#f59e0b; color:#1f2937; } .content { margin-top:50px; } .header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:3px solid #4f46e5; padding-bottom:12px; margin-bottom:16px; } .header-left { display:flex; align-items:center; gap:12px; } .logo-box { width:44px; height:44px; background:linear-gradient(135deg,#f59e0b,#ea580c); border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-size:22px; font-weight:900; } .company-name { font-size:20px; font-weight:900; color:#4f46e5; letter-spacing:-0.5px; } .company-sub { font-size:10px; color:#7c3aed; font-weight:600; margin-top:2px; } .header-right { text-align:right; } .report-title { font-size:14px; font-weight:800; color:#1e1b4b; } .report-date { font-size:10px; color:#6b7280; margin-top:3px; } .print-time { font-size:9px; color:#9ca3af; margin-top:2px; } .summary-row { display:flex; gap:10px; margin-bottom:16px; } .summary-card { flex:1; border:1.5px solid #e5e7eb; border-radius:8px; padding:10px 12px; } .summary-card .label { font-size:9px; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; } .summary-card .value { font-size:18px; font-weight:900; margin-top:2px; } .card-adv .value { color:#dc2626; } .card-mat .value { color:#d97706; } .card-pay .value { color:#059669; } .card-total .value { color:#4f46e5; } .section { margin-bottom:18px; } .section-title { font-size:12px; font-weight:800; color:#1e1b4b; background:#f3f4f6; padding:6px 10px; border-left:4px solid #4f46e5; margin-bottom:0; display:flex; align-items:center; gap:6px; border-radius:0 4px 4px 0; } table { width:100%; border-collapse:collapse; font-size:11px; } thead tr { background:#4f46e5; color:white; } thead th { padding:7px 10px; text-align:left; font-weight:700; font-size:10px; letter-spacing:0.3px; } tbody tr { border-bottom:1px solid #f3f4f6; } tbody tr:nth-child(even) { background:#f9fafb; } tbody td { padding:6px 10px; color:#374151; } tfoot tr { background:#eef2ff; font-weight:700; } tfoot td { padding:7px 10px; color:#4f46e5; font-size:11px; } .footer { margin-top:24px; padding-top:12px; border-top:2px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; } .footer-sig .sig-line { width:140px; border-top:1.5px solid #374151; margin-top:28px; } .footer-sig .sig-label { font-size:9px; color:#6b7280; margin-top:3px; } @media print { .no-print-bar { display:none !important; } .content { margin-top:0; } body { padding:10px 14px; } @page { margin:8mm; size:A4; } }`; }
function getPrintHeader(reportTitle, dateLabel, subTitle) { return `<div class="header"><div class="header-left"><div class="logo-box">S</div><div><div class="company-name">Sanjineer</div><div class="company-sub">Er Sanjeev Â· Construction Manager App</div></div></div><div class="header-right"><div class="report-title">${reportTitle}</div><div class="report-date" style="font-weight:700;font-size:13px;color:#1e1b4b;margin-top:4px">${dateLabel}</div>${subTitle?`<div style="font-size:11px;font-weight:600;color:#7c3aed;margin-top:2px">${subTitle}</div>`:''}<div class="print-time">Printed: ${new Date().toLocaleString('en-IN')}</div></div></div>`; }
function getPrintFooter() { return `<div class="footer"><div class="footer-sig"><div class="sig-line"></div><div class="sig-label">Site Supervisor</div></div><div class="footer-sig" style="text-align:center"><div class="sig-line" style="margin:0 auto;"></div><div class="sig-label">Prepared By</div></div><div class="footer-sig" style="text-align:right"><div class="sig-line" style="margin-left:auto;"></div><div class="sig-label">Authorized</div></div></div><div style="text-align:center;margin-top:10px;font-size:8px;color:#d1d5db;">Generated by Sanjineer Â· Construction Manager App</div>`; }
function openPrintWindow(html) { const pw = window.open('','_blank','width=900,height=750'); if(pw) { pw.document.write(html); pw.document.close(); } else showToast('Please allow popups to print','error'); }function printDailyReport() { const sel = dailyReportDate.toISOString().split('T')[0]; const dateLabel = new Date(sel+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); const att = dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.date===sel)); const mats = allData.filter(d=>d.type==='material'&&d.date===sel&&!d.is_petty_cash); const totalMat = mats.reduce((s,m)=>s+(parseFloat(m.cost)||0),0); const wAdv = att.reduce((s,d)=>s+(parseFloat(d.advance)||0),0); const cAdv = allData.filter(d=>d.type==='contractor_payment'&&d.date===sel).reduce((s,d)=>s+(parseFloat(d.payment)||0),0); const totalAdv = wAdv+cAdv; const totalWorkerPay = att.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const grp={}; att.forEach(a=>{ if(!grp[a.category]) grp[a.category]=[]; grp[a.category].push(a); }); const order=['Mason','Labour','Carpenter','Helper','Fitter','Fitter Helper','Supervisor']; const sortedCats = Object.keys(grp).sort((a,b)=>(order.indexOf(a)+1||999)-(order.indexOf(b)+1||999)); const catRows = sortedCats.map(cat=>{ const wks=grp[cat]; const hrs=wks.reduce((s,w)=>s+(parseFloat(w.hours)||0),0); const wd=wks[0].work_done||'\u2014'; const totalPay=wks.reduce((s,w)=>s+(parseFloat(w.hours)||0)*(parseFloat(w.hourly_wage)||0),0); return `<tr><td style="font-weight:700">${cat}</td><td style="text-align:center;font-weight:700;color:#4f46e5">${wks.length}</td><td style="text-align:center;font-weight:700">${hrs.toFixed(1)}h</td><td>${wd}</td><td style="text-align:right;font-weight:700;color:#059669">\u20B9${totalPay.toLocaleString('en-IN')}</td></tr>`; }).join(''); const matRows = mats.length ? mats.map(m=>`<tr><td>${m.material_name}</td><td style="text-align:center">${m.quantity||'\u2014'}</td><td style="text-align:right;font-weight:600">\u20B9${parseFloat(m.cost||0).toLocaleString('en-IN')}</td></tr>`).join('') : '<tr><td colspan="3" style="text-align:center;color:#9ca3af;font-style:italic">No materials purchased today</td></tr>'; const cPays = allData.filter(d=>d.type==='contractor_payment'&&d.date===sel); const cPayRows = cPays.map(p=>`<tr><td>${p.contractor_name}</td><td style="text-align:right;font-weight:600">\u20B9${parseFloat(p.payment||0).toLocaleString('en-IN')}</td></tr>`).join(''); const html = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Daily Report - ${dateLabel}</title><style>${getPrintStyles()}</style></head><body><div class="no-print-bar"><button class="btn-back" onclick="window.close()">\u2190 Back</button><span style="flex:1;font-weight:700">Daily Site Report \u2014 ${dateLabel}</span><button class="btn-print" onclick="window.print()">\uD83D\uDDA8\uFE0F Print / Save PDF</button></div><div class="content">${getPrintHeader('\uD83D\uDCCB Daily Site Report', dateLabel)}<div class="summary-row"><div class="summary-card card-adv"><div class="label">Advances Paid</div><div class="value">\u20B9${totalAdv.toLocaleString('en-IN')}</div></div><div class="summary-card card-mat"><div class="label">Material Cost</div><div class="value">\u20B9${totalMat.toLocaleString('en-IN')}</div></div><div class="summary-card card-pay"><div class="label">Labour Payment</div><div class="value">\u20B9${totalWorkerPay.toLocaleString('en-IN')}</div></div><div class="summary-card card-total"><div class="label">Total Workers</div><div class="value">${att.length}</div></div></div><div class="section"><div class="section-title">\uD83D\uDC77 Labour Summary by Category</div>${sortedCats.length ? `<table><thead style="background:#7c3aed"><tr><th>Worker Type</th><th style="text-align:center">Count</th><th style="text-align:center">Total Hours</th><th>Work Done</th><th style="text-align:right">Payment Due</th></tr></thead><tbody>${catRows}</tbody><tfoot><tr><td colspan="4">TOTAL LABOUR PAYMENT</td><td style="text-align:right">\u20B9${totalWorkerPay.toLocaleString('en-IN')}</td></tr></tfoot></table>` : '<p style="padding:10px;color:#9ca3af;font-style:italic">No attendance recorded.</p>'}</div>${cPays.length ? `<div class="section"><div class="section-title">\uD83D\uDCB8 Team/Contractor Advances</div><table><thead style="background:#dc2626"><tr><th>Contractor / Team</th><th style="text-align:right">Advance Amount</th></tr></thead><tbody>${cPayRows}</tbody><tfoot><tr><td>TOTAL</td><td style="text-align:right">\u20B9${cAdv.toLocaleString('en-IN')}</td></tr></tfoot></table></div>` : ''}<div class="section"><div class="section-title">\uD83E\uDDF1 Materials Purchased</div><table><thead style="background:#d97706"><tr><th>Material Name</th><th style="text-align:center">Quantity</th><th style="text-align:right">Amount</th></tr></thead><tbody>${matRows}</tbody>${mats.length?`<tfoot><tr style="background:#fef3c7"><td colspan="2" style="color:#d97706">TOTAL MATERIAL COST</td><td style="text-align:right;color:#d97706">\u20B9${totalMat.toLocaleString('en-IN')}</td></tr></tfoot>`:''}</table></div>${getPrintFooter()}</div></body></html>`; openPrintWindow(html); }function printMonthlyReport() { const selEl = document.getElementById('print-month-select') || document.getElementById('export-month-select'); const selMonth = selEl ? selEl.value : getMonthString(currentViewMonth); const monthDate = new Date(selMonth + '-01T00:00:00'); const monthLabel = monthDate.toLocaleDateString('en-IN',{month:'long',year:'numeric'}); const workers = allData.filter(d=>d.type==='worker'); const contractors = allData.filter(d=>d.type==='contractor'); const allMonthAtt = dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.date&&d.date.startsWith(selMonth))); const allContPays = allData.filter(d=>d.type==='contractor_payment'&&d.date&&d.date.startsWith(selMonth)); const totalAttDays = allMonthAtt.filter(a=>parseFloat(a.hours)>0).length; const totalWorkerPay = allMonthAtt.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const totalWorkerAdv = allMonthAtt.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const totalContAdv = allContPays.reduce((s,p)=>s+(parseFloat(p.payment)||0),0); const totalAdv = totalWorkerAdv + totalContAdv; let grandPay = 0, grandAdv = 0; let attendanceBody = '';
const buildTeamSection = (teamName, teamLabel, teamWorkers, teamPays, contractAmt) => { const teamWorkerPay = teamWorkers.reduce((s,w)=>{const wa=allMonthAtt.filter(a=>a.name===w.name);return s+wa.reduce((ss,a)=>ss+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0);},0); const teamWorkerAdv = teamWorkers.reduce((s,w)=>{return s+allMonthAtt.filter(a=>a.name===w.name).reduce((ss,a)=>ss+(parseFloat(a.advance)||0),0);},0); const teamContAdv = teamPays.reduce((s,p)=>s+(parseFloat(p.payment)||0),0); const teamTotalPay = teamWorkerPay + contractAmt; const teamTotalAdv = teamWorkerAdv + teamContAdv; grandPay += teamTotalPay; grandAdv += teamTotalAdv; let rows = `<tr style="background:#1e1b4b;color:white"><td colspan="5" style="font-weight:800;font-size:12px;padding:9px 12px">\uD83C\uDFD7\uFE0F ${teamLabel}</td><td style="text-align:right;color:#fbbf24;font-weight:700;font-size:11px;padding:9px 12px">Adv: \u20B9${teamTotalAdv.toLocaleString('en-IN')}</td><td style="text-align:right;color:#86efac;font-weight:700;font-size:11px;padding:9px 12px">Pay: \u20B9${teamTotalPay.toLocaleString('en-IN')}</td></tr>`;
teamWorkers.forEach(w=>{ const wa=allMonthAtt.filter(a=>a.name===w.name); const days=wa.filter(a=>parseFloat(a.hours)>0).length; const hrs=wa.reduce((s,a)=>s+(parseFloat(a.hours)||0),0); const adv=wa.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const pay=wa.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); rows+=`<tr><td style="padding-left:18px;font-weight:600">${w.name}</td><td style="color:#6b7280">${w.category}</td><td style="text-align:center;font-weight:700;color:#4f46e5">${days}</td><td style="text-align:center">${hrs.toFixed(1)}h</td><td style="text-align:right">\u20B9${(w.hourly_wage||0).toLocaleString('en-IN')}/hr</td><td style="text-align:right;color:#d97706;font-weight:600">${adv>0?'\u20B9'+adv.toLocaleString('en-IN'):'\u2014'}</td><td style="text-align:right;color:#059669;font-weight:700">\u20B9${pay.toLocaleString('en-IN')}</td></tr>`; });
if(teamPays.length) teamPays.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).forEach(p=>{rows+=`<tr style="background:#fff7ed"><td colspan="5" style="padding-left:18px;font-style:italic;color:#92400e;font-size:10px">\uD83D\uDCB8 Team Advance paid on ${p.date}</td><td style="text-align:right;color:#dc2626;font-weight:700">\u20B9${parseFloat(p.payment||0).toLocaleString('en-IN')}</td><td style="color:#9ca3af;font-size:10px;text-align:right">advance</td></tr>`;});
rows+=`<tr style="background:#ede9fe;border-top:2px solid #7c3aed"><td colspan="4" style="font-weight:800;color:#4f46e5;padding:8px 12px">\u21B3 ${teamName} \u2014 TOTAL</td><td style="text-align:right;font-weight:700;color:#374151">${teamWorkers.length} workers</td><td style="text-align:right;font-weight:800;color:#dc2626">\u20B9${teamTotalAdv.toLocaleString('en-IN')}</td><td style="text-align:right;font-weight:800;color:${(teamTotalPay-teamTotalAdv)>=0?'#059669':'#dc2626'}">\u20B9${(teamTotalPay-teamTotalAdv).toLocaleString('en-IN')}</td></tr><tr><td colspan="7" style="padding:3px;background:#f9fafb"></td></tr>`; return rows; };
contractors.forEach(c => { const tw=workers.filter(w=>w.team_name===c.contractor_name); const tp=allContPays.filter(p=>p.contractor_name===c.contractor_name); attendanceBody+=buildTeamSection(c.contractor_name,`${c.contractor_name} (${c.contractor_type||'Team'} \u00B7 ${tw.length} workers)`,tw,tp,parseFloat(c.total_contract)||0); });
const unassigned=workers.filter(w=>!w.team_name||!contractors.some(c=>c.contractor_name===w.team_name)); if(unassigned.length) attendanceBody+=buildTeamSection('Unassigned',`Unassigned Workers (${unassigned.length})`,unassigned,[],0); const grandBalance=grandPay-grandAdv;
const contSummaryRows=contractors.map(c=>{ const tw=workers.filter(w=>w.team_name===c.contractor_name); const ta=allMonthAtt.filter(a=>tw.some(w=>w.name===a.name)); const wPay=ta.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const wAdv=ta.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const cAdv2=allContPays.filter(p=>p.contractor_name===c.contractor_name).reduce((s,p)=>s+(parseFloat(p.payment)||0),0); const tPay=wPay+(parseFloat(c.total_contract)||0); const tAdv=wAdv+cAdv2; const bal=tPay-tAdv; return `<tr><td style="font-weight:700">${c.contractor_name}</td><td>${c.contractor_type||'Team'}</td><td style="text-align:center">${tw.length}</td><td style="text-align:right">\u20B9${tPay.toLocaleString('en-IN')}</td><td style="text-align:right;color:#dc2626;font-weight:600">\u20B9${tAdv.toLocaleString('en-IN')}</td><td style="text-align:right;font-weight:800;color:${bal>=0?'#059669':'#dc2626'}">\u20B9${bal.toLocaleString('en-IN')}</td></tr>`; }).join('');
const html=`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Monthly Report \u2014 ${monthLabel}</title><style>${getPrintStyles()}</style></head><body><div class="no-print-bar"><button class="btn-back" onclick="window.close()">\u2190 Back</button><span style="flex:1;font-weight:700;font-size:13px">Monthly Report \u2014 ${monthLabel}</span><button class="btn-print" onclick="window.print()">\uD83D\uDDA8\uFE0F Print / Save PDF</button></div><div class="content">${getPrintHeader('\uD83D\uDCC5 Monthly Attendance & Payment Report',monthLabel,'Worker-wise Attendance \u00B7 Team Advances \u00B7 Final Payment')}<div class="summary-row"><div class="summary-card card-total"><div class="label">Total Attendance Days</div><div class="value">${totalAttDays}</div></div><div class="summary-card card-pay"><div class="label">Total Labour Payment</div><div class="value">\u20B9${totalWorkerPay.toLocaleString('en-IN')}</div></div><div class="summary-card card-adv"><div class="label">Total Advances Given</div><div class="value">\u20B9${totalAdv.toLocaleString('en-IN')}</div></div><div class="summary-card" style="border-color:${grandBalance>=0?'#059669':'#dc2626'}"><div class="label">Net Balance Due</div><div class="value" style="color:${grandBalance>=0?'#059669':'#dc2626'}">\u20B9${grandBalance.toLocaleString('en-IN')}</div></div></div><div class="section"><div class="section-title">\uD83D\uDC77 Worker Attendance & Payment \u2014 Grouped by Team \u00B7 ${monthLabel}</div>${attendanceBody?`<table><thead style="background:#4f46e5"><tr><th>Worker Name</th><th>Category</th><th style="text-align:center">Days</th><th style="text-align:center">Hours</th><th style="text-align:right">Wage/hr</th><th style="text-align:right">Advances</th><th style="text-align:right">Final Pay</th></tr></thead><tbody>${attendanceBody}</tbody><tfoot><tr style="background:#1e1b4b;color:white"><td colspan="5" style="font-weight:900;font-size:13px;padding:10px 12px">GRAND TOTAL \u2014 ${monthLabel}</td><td style="text-align:right;font-weight:900;color:#fbbf24;font-size:13px">\u20B9${grandAdv.toLocaleString('en-IN')}</td><td style="text-align:right;font-weight:900;color:#86efac;font-size:13px">\u20B9${grandPay.toLocaleString('en-IN')}</td></tr><tr style="background:#312e81;color:white"><td colspan="5" style="font-weight:800;color:#c4b5fd;padding:8px 12px">NET BALANCE DUE (Pay \u2212 Advances)</td><td colspan="2" style="text-align:right;font-weight:900;font-size:15px;color:${grandBalance>=0?'#86efac':'#fca5a5'};padding:8px 12px">\u20B9${grandBalance.toLocaleString('en-IN')}</td></tr></tfoot></table>`:'<p style="padding:10px;color:#9ca3af">No attendance recorded for this month.</p>'}</div>${contractors.length?`<div class="section"><div class="section-title">\uD83D\uDCB8 Team / Contractor Payment Summary \u2014 ${monthLabel}</div><table><thead style="background:#dc2626"><tr><th>Team / Contractor</th><th>Type</th><th style="text-align:center">Workers</th><th style="text-align:right">Total Payment</th><th style="text-align:right">Advances Paid</th><th style="text-align:right">Balance Due</th></tr></thead><tbody>${contSummaryRows}</tbody><tfoot><tr style="background:#7f1d1d;color:white"><td colspan="3" style="font-weight:800">TOTAL</td><td style="text-align:right;font-weight:800">\u20B9${grandPay.toLocaleString('en-IN')}</td><td style="text-align:right;font-weight:800;color:#fca5a5">\u20B9${grandAdv.toLocaleString('en-IN')}</td><td style="text-align:right;font-weight:900;color:${grandBalance>=0?'#86efac':'#fca5a5'}">\u20B9${grandBalance.toLocaleString('en-IN')}</td></tr></tfoot></table></div>`:''}${getPrintFooter()}</div></body></html>`; openPrintWindow(html); }function exportPaymentsExcel() { const vms=getMonthString(currentViewMonth); const contractors=allData.filter(d=>d.type==='contractor'); if(!contractors.length){showToast('No teams to export','error');return;} const wb=XLSX.utils.book_new(); const data=[['Sanjineer - Payment Advances Report'],['Month: '+formatMonthYear(currentViewMonth)],['Generated: '+new Date().toLocaleDateString('en-IN')],[],['Team/Contractor','Type','Workers','Total Payment','Total Advances','Net Balance']]; contractors.forEach(c=>{ const tw=allData.filter(d=>d.type==='worker'&&d.team_name===c.contractor_name); const ta=dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.date&&d.date.startsWith(vms)&&tw.some(w=>w.name===d.name))); const wPay=ta.reduce((s,a)=>s+(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0),0); const wAdv=ta.reduce((s,a)=>s+(parseFloat(a.advance)||0),0); const payments=allData.filter(d=>d.type==='contractor_payment'&&d.contractor_name===c.contractor_name&&d.date&&d.date.startsWith(vms)); const cPay=payments.reduce((s,p)=>s+(parseFloat(p.payment)||0),0); const totalPay=wPay+(parseFloat(c.total_contract)||0); const totalAdv=wAdv+cPay; data.push([c.contractor_name,c.contractor_type||'Team',tw.length,totalPay,totalAdv,totalPay-totalAdv]); }); const ws1=XLSX.utils.aoa_to_sheet(data); ws1['!cols']=[{wch:20},{wch:14},{wch:10},{wch:16},{wch:16},{wch:14}]; XLSX.utils.book_append_sheet(wb,ws1,'Teams Summary');
contractors.forEach(c=>{ const payments=allData.filter(d=>d.type==='contractor_payment'&&d.contractor_name===c.contractor_name&&d.date&&d.date.startsWith(vms)); if(!payments.length) return; const pData=[['Payment History: '+c.contractor_name],['Month: '+formatMonthYear(currentViewMonth)],[],['Date','Amount']]; payments.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).forEach(p=>pData.push([p.date,parseFloat(p.payment)||0])); pData.push([]); pData.push(['TOTAL',payments.reduce((s,p)=>s+(parseFloat(p.payment)||0),0)]); const ws=XLSX.utils.aoa_to_sheet(pData); ws['!cols']=[{wch:16},{wch:14}]; const sheetName=c.contractor_name.substring(0,28).replace(/[/?*[\]]/g,''); XLSX.utils.book_append_sheet(wb,ws,sheetName); });
const workers=allData.filter(d=>d.type==='worker'); const advData=[['Sanjineer - Worker Advances Detail'],['Month: '+formatMonthYear(currentViewMonth)],[],['Worker','Category','Team','Date','Hours','Advance','Payment']]; workers.forEach(w=>{ const att=dedupeAtt(allData.filter(d=>d.type==='attendance'&&d.name===w.name&&d.date&&d.date.startsWith(vms))); att.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).forEach(a=>{ if(parseFloat(a.advance)>0) advData.push([w.name,w.category,w.team_name||'-',a.date,parseFloat(a.hours)||0,parseFloat(a.advance)||0,(parseFloat(a.hours)||0)*(parseFloat(a.hourly_wage)||0)]); }); }); const ws2=XLSX.utils.aoa_to_sheet(advData); ws2['!cols']=[{wch:20},{wch:12},{wch:14},{wch:12},{wch:8},{wch:12},{wch:14}]; XLSX.utils.book_append_sheet(wb,ws2,'Worker Advances'); XLSX.writeFile(wb,'Payments_'+vms+'.xlsx'); showToast('Excel exported!','success'); }

(function() { const manifest = { name: 'Sanjineer - Construction Manager App', short_name: 'ConstructMgr', description: 'Construction site management app', start_url: '.', display: 'standalone', background_color: '#0f172a', theme_color: '#4f46e5', icons: [{ src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="36" fill="%234f46e5"/><text x="96" y="130" font-size="100" text-anchor="middle">\uD83C\uDFD7\uFE0F</text></svg>', sizes: '192x192', type: 'image/svg+xml' }] }; const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'}); document.getElementById('pwa-manifest').href = URL.createObjectURL(blob); })();

window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredInstallPrompt = e; const dismissed = localStorage.getItem('pwa_banner_dismissed'); if (!dismissed) document.getElementById('pwa-banner').style.display = 'flex'; });
function installPWA() { if (deferredInstallPrompt) { deferredInstallPrompt.prompt(); deferredInstallPrompt.userChoice.then((c) => { if (c.outcome === 'accepted') showToast('App installed!', 'success'); document.getElementById('pwa-banner').style.display = 'none'; }); deferredInstallPrompt = null; } }
function dismissPWA() { document.getElementById('pwa-banner').style.display = 'none'; localStorage.setItem('pwa_banner_dismissed', '1'); }
window.addEventListener('appinstalled', () => { document.getElementById('pwa-banner').style.display = 'none'; showToast('App installed successfully!', 'success'); });

// FIX: Use window.onload instead of DOMContentLoaded to ensure all external scripts (Tailwind, SheetJS) are fully loaded before init
window.addEventListener('load', () => { init(); });
</script>
<!-- FIX: Scripts moved to end of body with defer so they don't block page rendering -->
<script defer src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>